CC=sdcc
CFLAGS=-mstm8
CFLAGS+=-I/usr/local/share/sdcc/include
STM8LIBDIR=../stm8_lib
STM8LIBINC=$(STM8LIBDIR)/inc
DEFINES=STM8S003
SRC=main
OUT_DIR=build/




STDLIBNAME=libstm8s003.a

all: compile

compile:
	mkdir -p $(OUT_DIR)
	$(CC) $(CFLAGS) -I$(STM8LIBINC) -D $(DEFINES) -L $(STM8LIBDIR) -l $(STDLIBNAME) -o $(OUT_DIR) $(SRC).c
	packihx $(OUT_DIR)/$(SRC).ihx > $(OUT_DIR)/$(SRC).hex

prepare:
	packihx $(OUT_DIR)/$(SRC).ihx > $(OUT_DIR)/$(SRC).hex

clean:
	rm -Rrf $(OUT_DIR)

erase:
	vsprog -cstm8s103f3 -ms -oe -V"tvcc.set 3300"
	vsprog -V"tvcc.set 0" -V"tvcc.set 3300"

flash: erase
	vsprog -cstm8s103f3 -ms -owf -I $(OUT_DIR)/$(SRC).hex -V"tvcc.set 3300"
	vsprog -V"tvcc.set 0" -V"tvcc.set 3300"
